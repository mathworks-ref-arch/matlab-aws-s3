# Encryption Support

This document describes the types of encryption supported by AWS S3™ using this package in addition to other related information.

## Supported encryption schemes

| Scheme name | Description | Encryption on Client or Server |Key Management Client/Server | Capability Read/get Write/put | Comment |
|--------------|--------------|:------:|:---------:|:--------:|--------------|
| NOENCRYPTION | No encryption performed | N/A | N/A | Read & Write | Data is not encrypted at rest |
| KMSCMK | KMS managed customer(2) master Key | Client-side | KMS Server-side managed key | Read & Write | Customer Master Key ID required |
| CSESMK(1) | Client-side encryption with a client-side symmetric master key | Client-side | Client provided key | Read & Write | Uses up to 256-bit AES symmetric master key |
| SSEC | Server-side encryption with customer provided key | Server-side | Customer provided key | Read & Write | Key is not stored by S3 |
| SSEKMS | Server-side encryption using a KMS managed key | Server-side | KMS server-side managed key | Read & Write | Default master and customer created keys supported |
| SSES3 | Server-side encryption using an S3 managed key | Server-side | S3 server-side managed key | Read & Write | Used as the default S3 encryption method |
| CSEAMK(1) | Client-side encryption with a client-side asymmetric master key | Client-side | Client provided key pair | Read & Write | RSA key pairs must be at least 512-bit |
|    |    |    |    |    |    |
| CloudHSM(3) | CloudHSM™ hardware secured key storage | - | - | - | Not currently supported |
| datastore | SSES3, SSEKMS (preconfigured key only) | Server-side | N/A | Read & Write(4) | Read support from R2017a, Write support from R2018a |


(1) Requires unrestricted encryption policy support by the JRE. Please see the appropriate section in the documentation at: https://www.oracle.com/technetwork/java/javase/jre-8-readme-2095710.html   
(2) In AWS terminology "Customer" equates to the end user of the S3 service.   
(3) To use this package with CloudHSM please contact MathWorks®.   
(4) Some restrictions apply.

For more information on protecting data in S3 see:   
<http://docs.aws.amazon.com/AmazonS3/latest/dev/DataDurability.html>

## Encryption scope
In all supported cases an individual scheme applies at the client level, i.e. once a client is initialized to use a particular scheme it can only use that scheme and if in the unlikely event that a mix of schemes are required additional clients should be used. One can further categorize the based on whether the scheme and key combination applies for the all operations of a client (e.g. put/get) once initialized or if it applies on a per operation basis. The following table summarizes this.

| Scheme name | Client / Server-side encryption | Per Client / Per Operation | Comment |
|--------|:---------:|:--------:|--------------------------------------------|
| KMSCMK | Client-side | Client | Uses a Key ID to select a key that is used on the client side by the AWS S3 SDK but managed by KMS. |
|CSESMK | Client-side | Client | A symmetric customer key of type `javax.crypto.spec.SecretKeySpec` is required when initializing a client. `CSESymmetricMasterKey()` can be used to generate such a key. |
| CSEAMK | Client-side | Client | An asymmetric customer key pair of type `java.security.KeyPair` is required when initializing a client. `CSEasymmetricMasterKey()` can be used to generate such a key pair. |
| SSES3 | Server-side | Client | Can be more cost effective than KMS if KMS functionality is not required. |
| SSEC | Server-side | Operation | A key of type `javax.crypto.spec.SecretKeySpec` is required for each request. Calling `generateSSECKey()` will produce such a key. |
| SSEKMS | Server-side | Operation | A `SSEAwsKeyManagementParam` is required with each request to specify the Key ID, the default master key can also be used. Calling `setSSEAwsKeyManagementParams()` will generate such a parameter object. |

It is advised to carry out all related communications over HTTPS connections rather than HTTP. Certain S3 operations are not supported over HTTP and will fail.

## Encryption key generation operations
*Please note that MATLAB® or other MathWorks software does not perform the key generation, encryption or decryption or processes supported by this package.* Encryption and decryption is strictly performed by the Amazon S3 client libraries in the case of client-side and by Amazon's S3 servers in the case of server-side. Key generation is performed as follows:   

`generateSSECKey()` : generated by Java libraries, type formatted by an Amazon S3 library.  
`generateCSESymmetricMasterKey()` : generated by Java libraries.   
`generateCSEAsymmetricMasterKey()` : generated by Java libraries.   

In practice, it is expected that normally keys will be sourced from and managed by other 3rd party software with appropriate precautions in place.

## Server-side Encryption (SSE)
For encryption options that leverage the server-side capabilities of AWS S3, the supported schemes can take the following values for using server-side encryption:
* SSEC (with Customer Key)
* SSEKMS (with Key Management Service)
* SSES3 (with S3 managed Keys)

### SSEC - Server Side encryption with Customer provided key
AWS does not generate or manage the key. However one is trusting AWS to apply the encryption at the server side thus AWS does see the unencrypted data. The key is provided when calling the relevant methods e.g. putObject() or getObject():
```
s3 = aws.s3.Client();
s3.encryptionScheme = 'ssec';
s3.initialize();

% generate a customer key
my_SecretKey = s3.generateSSECKey();

% upload the object using the key
s3.putObject(bucketname, myfile, my_SecretKey);
```

### SSEKMS - Server Side Encryption using Key Management Service (KMS)
In this case, the ID of the key for the server side to use is not specified. By default, a master key ID will be used. Specific key IDs can also be specified. Policies can be set to require that specific keys are used and keys can be changed using the IAM console. Keys are AWS region specific.

### SSES3 - Server Side Encryptions with Keys managed by S3
This encryption scheme is managed by S3 and configured by the bucket policy permissions. Please refer to the AWS documentation to configure the resource to deny any requests that do not include the header to encrypt the object using SSES3.


## Client-side Encryption (CSE)

The client has the following encryption related parameters:

* encryptionScheme - encryption scheme of choice see options below
* CSEAMKKeyPair - Client-side Asymmetric Master Key argument of type java.security.KeyPair
* CSESMKKey - Client-side Symmetric Master Key argument of type javax.crypto.spec.SecretKeySpec
* KMSCMKKeyID - a KMS managed Customer Master Key ID
* KMSCMK (with Customer managed Key from the Key Management Service)

encryptionScheme is a enumeration that can take the following values for using client-side encryption:
* NOENCRYPTION (default)
* CSESMK
* CSEAMK

Please take note of the code used by the various key generation and handling calls described below regarding their operation.

### CSESMK - client side encryption symmetric master key
A symmetric 256 bit AES key can be generated using:
```
s3 = aws.s3.Client();
s3.encryptionScheme = 'CSESMK';
s3.CSESMKKey = s3.generateCSESymmetricMasterKey('AES', 256);
s3.intialize();
```
AES 256 bit keys should not be considered secure as they can feasibly be brute forced. This method should not be used for sensitive data. 128 and 196 bit AES keys can also be generated using this method, though may not be accepted by AWS.

### CSEAMK - client side encryption asymmetric master key
An asymmetric RSA 1024 bit key pair can be generated using:
```
s3 = aws.s3.Client();
s3.encryptionScheme = 'CSEAMK';
s3.CSEAMKKeyPair = s3.generateCSEAsymmetricMasterKey(1024);
s3.intialize();
```
The minimum supported RSA key size is 512 bit. Considerably longer RSA keys are recommended. When working with key pairs two supporting functions are available `saveKeyPair` and `loadKeyPair`. `saveKeyPair` writes a key pair to two files one for the public key and one for the private key e.g.:
```
saveKeyPair(myKeyPair,'mypublic.key','myprivate.key');
```
`loadKeyPair` reads both a public and private key from a file to produce a complete keypair e.g.:
```
myKeyPair = loadKeyPair('mypublic.key','myprivate.key');
```
Alternatively, it can produce a key pair with just the public key for example if working with a 3rd party public key that has been distributed, e.g.:
```
publicOnlyPair = loadKeyPair('mypublic.key');
```

### KMSCMK - Key Management Service with a Customer Master Key
Encryption is performed at the client side. The key is specified using a key ID of the form: a1234567-bcd1-234e-fab5-c6d7e89f0a1b Note, this is an ID of a key held by AWS not the key itself. Keys are AWS region specific.
```
s3 = aws.s3.Client();
s3.KMSCMKKeyID = 'c6123457-cea5-476a-abb9-a0a4f678e8e';
s3.intialize();
```

## Encryption examples

### SSEKMS - a server-side encryption with KMS
The following example shows how one can work with SSEKMS. It uses the default master key to encrypt a file which is uploaded. This file is then downloaded and in the process decrypted automatically.
```
%% Initialize a client for SSEKMS
s3 = aws.s3.Client();
s3.encryptionScheme = 'ssekms';
s3.initialize();

% use the default KMS key ID
sse_params = s3.setSSEAwsKeyManagementParams();

%% Save some data to a temporary file
x = rand(3);
myfile = [tempname,'.mat'];
save(myfile,'x');

%% Create a bucket to hold the data object and upload the data to S3 using the key ID
% a save command is also provided
bucketname = 'com-example-my-test-bucket';
s3.createBucket(bucketname);
s3.putObject(bucketname, myfile, sse_params);

% Examine the object's meta data to see the encryption references
printmetadata = true;
metadata = s3.getObjectMetadata(bucketname,myfile,printmetadata);
% in the output look for the SSEAwsKmsKeyId ID field to reflect the value of the key used
% and the SSEAlgorithm field to indicate KMS is in use i.e. aws:kms

% Retrieve the object from S3 using getObject and then load the file into the workspace
% note because the decryption is performed on the server, the key or key ID is
% not specified on download and the decryption is transparent. A load command is also provided.
% clear x and delete myfile to ensure that x is returned from the downloaded file
clear x;
delete(myfile);
s3.getObject(bucketname, myfile);

load(myfile);
x

%% Cleanup the session
delete(myfile);
s3.deleteBucket(bucketname);
s3.shutdown();
```

## CSESMK - a client-side symmetric master key encryption
In this example, a key is generated locally on the client side.
Note that client-side encryption unlimited strength encryption is required.

```
%% Initialize a client and provide the key that was just generated
s3 = aws.s3.Client();
s3.encryptionScheme = 'CSESMK';
s3.CSESMKKey  = s3.generateCSESymmetricMasterKey();
s3.initialize();

%% Save some data to a temporary file
x = rand(3);
myfile = [tempname,'.mat'];
save(myfile,'x');

% the client holds the key so there is don't need to provide it when doing the putObject call
bucketname = 'com-example-my-test-bucket';
s3.createBucket(bucketname);
s3.putObject(bucketname, myfile);

% Remove the local copy of the data
delete(myfile);

%% Start another client that does not have the key and download the object
% aside from the key this client uses the same credentials as the first so it has
% permission to read the object
s3B = aws.s3.Client();
s3B.initialize();

s3B.getObject(bucketname, myfile);
% this time can't load the file it appears corrupt due to being encrypted
load(myfile);

% cleanup
s3.deleteObject(bucketname, myfile);
s3.deleteBucket(bucketname);
delete(myfile);
s3.shutdown;
s3B.shutdown;
```


## Notes:
CAUTION: S3 encrypts only the object data. Any object metadata is not encrypted.

Relevant Links:   

* <http://docs.aws.amazon.com/AmazonS3/latest/dev/kms-using-sdks.html>
* <http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingKMSEncryption.html>
* <http://docs.aws.amazon.com/kms/latest/developerguide/services-s3.html>
* <http://docs.aws.amazon.com/kms/latest/developerguide/programming-top.html>
* <https://d0.awsstatic.com/whitepapers/aws-security-best-practices.pdf>


[//]: #  (Copyright 2018 The MathWorks, Inc.)
